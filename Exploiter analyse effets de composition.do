***************************************************************************

* ---------- Programme pour reconstruire les coûts de commerce
* ---------- estimés "overall" et "pure", en base 100 en 1974 tous les deux

* Mai 2017: Construire la somme des deux termes IetA, overall et purs

****************************************************************************

net install grc1leg, from (http://www.stata.com/users/vwiggins)


version 14.1



if "`c(username)'" =="guillaumedaudin" {
	global dir_baseline_results "~/Documents/Recherche/2013 -- Trade Costs -- local/results/baseline"
	global dir_referee1 "~/Documents/Recherche/2013 -- Trade Costs -- local/results/referee1"
	global dir "~/Documents/Recherche/2013 -- Trade Costs -- local"
	global dir_comparaison "~/Documents/Recherche/2013 -- Trade Costs -- local/results/comparaisons_various"
	global dir_temp ~/Downloads/temp_stata
	global dir_results "~/Documents/Recherche/2013 -- Trade Costs -- local/results"
	global dir_git "~/Répertoires Git/trade_costs_git"
	
	
}


*** Juillet 2020: Lise, tout sur mon OneDrive


/* Fixe Lise P112*/
if "`c(hostname)'" =="LAB0271A" {
	 

	* baseline results sur hummels_tra dans son intégralité
    global dir_baseline_results "C:\Users\lpatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\results\baseline"
	
		
	* résultats selon méthode référé 1
	global dir_referee1 "C:\Users\lpatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\results\referee1"
	
	* stocker la comparaison des résultats
	global dir_comparaison "C:\Users\lpatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\results\referee1\comparaison_baseline_referee1"
	
	/* Il me manque pour faire méthode 2 en IV 
	- IV_referee1_panel/results_estimTC_`year'_sitc2_3_`mode'.dta
	- IV_referee1_yearly/results_estimTC_`year'_sitc2_3_`mode'.dta
	
	*/
	
	global dir_temp "C:\Users\lpatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\temp"
	global dir "C:\Users\lpatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs"
	global dir_results "C:\Users\lpatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\results"
	 
	 
	 
	}

/* Nouveau portable Lise */
if "`c(hostname)'" =="MSOP112C" {

	* baseline results sur hummels_tra dans son intégralité
    global dir_baseline_results "C:\Users\Ipatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\results\baseline"
		
	* résultats selon méthode référé 1
	global dir_referee1 "C:\Users\Ipatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\results\referee1"
	
	* stocker la comparaison des résultats
	global dir_comparaison "C:\Users\Ipatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\results\referee1\comparaison_baseline_referee1"
	
	/* Il me manque pour faire méthode 2 en IV 
	- IV_referee1_panel/results_estimTC_`year'_sitc2_3_`mode'.dta
	- IV_referee1_yearly/results_estimTC_`year'_sitc2_3_`mode'.dta
	
	*/
	
	global dir_temp "C:\Users\Ipatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\temp"
	global dir "C:\Users\Ipatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs"
	global dir_results "C:\Users\Ipatureau\OneDrive - Université Paris-Dauphine\Université Paris-Dauphine\trade_costs\results"
	}



set more off
*cd $dir/results/

** On part sur estimation en 3 digits ***

capture program drop compare_trends_inTC
program compare_trends_inTC
	args year mode sitc


use "$dir_baseline_results/results_estimTC_`year'_prod5_sect3_`mode'.dta", clear

keep if year==`year'
keep if mode=="`mode'"
capture rename `mode'_val val


foreach secteur in 0(1)9 {
	if "`sitc'"=="`secteur'" keep if substr(sector,1,1)=="`sitc'"
}

if "`sitc'"=="primary" keep if substr(sector,1,1)=="0" | substr(sector,1,1)=="1" /// 
	| substr(sector,1,1)=="2" | substr(sector,1,1)=="3" | substr(sector,1,1)=="4" /// 
	| substr(sector,1,3)=="667" | substr(sector,1,2)=="68"
	
	
	
	
if "`sitc'"=="manuf" drop if substr(sector,1,1)=="0" | substr(sector,1,1)=="1" /// 
	| substr(sector,1,1)=="2" | substr(sector,1,1)=="3" | substr(sector,1,1)=="4" /// 
	| substr(sector,1,3)=="667" | substr(sector,1,2)=="68" | substr(sector,1,1)=="9"
	

*gen prix_trsp = prix_caf/prix_fob -1
replace terme_I = terme_I-1

gen terme_AetI = terme_A+terme_I
*gen termeiceberg = terme_iceberg -1


local type prix_trsp terme_I terme_A terme_AetI /*termeiceberg */ prix_fob
keep `type' year mode val

foreach x in `type' {

	quietly sum `x'  [fweight= val], det
	generate `x'_mp = r(mean)
	generate `x'_med = r(p50)
		
}



keep year mode *_mp/* termeiceberg_mp prix_trsp_med termeAetI_med termeiceberg_med */
rename prix_trsp_mp terme_obs_mp
keep if _n ==1


save "$dir_temp/data_baseline_`year'_`mode'_`sitc'.dta", replace


end



********************************

** Compiler les résultats sur toutes les années



capture program drop compilation_effets_compositions
program compilation_effets_compositions
args sitc
* expl : compilation_effets_compositions 6


set more off
local mode ves air



foreach x in `mode' {
	
	use "$dir_temp/data_baseline_1974_`x'_`sitc'", clear
	
	
	save "$dir_temp/compil_results_`x'_`sitc'", replace
	erase "$dir_temp/data_baseline_1974_`x'_`sitc'.dta"
	
}

* Les années ultérieures


foreach x in `mode' {

	foreach z of num 1975(1)2019 {
	
		use "$dir_temp/compil_results_`x'_`sitc'", clear
		append using "$dir_temp/data_baseline_`z'_`x'_`sitc'"
		
		save "$dir_temp/compil_results_`x'_`sitc'", replace
		erase "$dir_temp/data_baseline_`z'_`x'_`sitc'.dta"
	
	}
blif
}

* Fusionner les deux bases (air, vessel)
* Cette base contient le cout de transport (observé, estimé nlI, estimé I&A) moyen et médian par année et par mode de transport
* Le prix moyen et médian: calcul pondéré par la valeur du flux

use "$dir_temp/compil_results_air_`sitc'", clear

append using "$dir_temp/compil_results_ves_`sitc'"

save "$dir_results/Effets de composition/compil_results_`sitc'", replace

erase "$dir_temp/compil_results_air_`sitc'.dta"
erase "$dir_temp/compil_results_ves_`sitc'.dta"

use "$dir_results/Effets de composition/compil_results_`sitc'", clear

local type terme_obs terme_A terme_I terme_AetI


foreach z in `type' {
	
	rename `z'_mp `z'
	

}



*reshape wide prix_trsp termeAetI termeiceberg, i(year) j(mode) string
reshape wide terme_obs terme_A terme_I terme_AetI, i(year) j(mode) string

local type terme_obs terme_A terme_I terme_AetI prix_fob
local mode air ves

foreach z in `type' {
	foreach x in `mode' {
	rename `z'`x' `z'_overall_`x'
	
}
}


save "$dir_results/Effets de composition/compil_results_`sitc'", replace

*** Etape : Construire les variables de TC "overall" pour avoir 100 en 1974

use "$dir_results/Effets de composition/compil_results_`sitc'", clear
sort year

local type terme_obs terme_A terme_I terme_AetI prix_fob
local mode air ves


foreach x in `type' {
	foreach z in `mode'{

	gen ref_`x'_`z' = `x'_overall_`z'[1]
	replace `x'_overall_`z' = 100*`x'_overall_`z'/ref_`x'_`z'

	}
}

drop ref*

save "$dir_results/Effets de composition/compil_results_`sitc'", replace


*** Etape suivante : Y ajouter l'estimation des coûts de transport composition effects excluded

use "$dir_results/Effets de composition/database_pureTC_`sitc'", clear



count

keep year terme_A_air_mp terme_A_ves_mp terme_A_air_np terme_A_ves_np ///
		  terme_A_air_74 terme_A_ves_74 terme_A_air_74_np terme_A_ves_74_np ///
		  terme_I_air_mp terme_I_ves_mp terme_I_air_np terme_I_ves_np ///
		  terme_I_air_74 terme_I_ves_74  terme_I_air_74_np terme_I_ves_74_np ///
		  terme_obs_air_mp terme_obs_ves_mp terme_obs_air_np terme_obs_ves_np

local type terme_A terme_I terme_obs
local mode air ves

foreach z in `type' {
	foreach x in `mode' {
	
			rename `z'_`x'_mp `z'_pure_`x'
			rename `z'_`x'_np `z'_pure_`x'_np
			
	}
}
	


* reconstruire le terme A+I "pur" à partir des termes I et A purs obtenus

/*
* Prendre la pondération en 1974

* cf table_extract_effetscomposition v27 juillet.xls dans le dossier résultats finaux
* poids relatif additif dans transport total en 1974 = 0.423 en air, 0.482 en vessel


gen terme_AetI_pure_air = 0.423*terme_A_pure_air + (1-0.423)*terme_I_pure_air
gen terme_AetI_pure_ves = 0.482*terme_A_pure_ves + (1-0.482)*terme_I_pure_ves


** Faire ça ou comme on fait ensuite ne change rien
** Pour mémoire, les graphiques correspondants sont stockés dans le dossier "$dir_results/Effets de composition"
** Sous les noms "graph_composition_all_ponderation74_pure.jpg", "graph_composition_primary_ponderation74_pure.jpg", "graph_composition_primary_ponderation74_pure.jpg"

	
*/



local type A I
local mode air ves

foreach x in `mode' {
	
		
	
	gen terme_I_pure_level_`x' = (terme_I_pure_`x'*(terme_I_`x'_74-1))/100 	
	gen terme_I_pure_level_`x'_np = (terme_I_pure_`x'*(terme_I_`x'_74_np-1))/100 
	
		
	gen terme_A_pure_level_`x' = (terme_A_pure_`x'*(terme_A_`x'_74))/100 	
	gen terme_A_pure_level_`x'_np = (terme_A_pure_`x'*(terme_A_`x'_74_np))/100 

	
	
	gen terme_AetI_pure_`x'= terme_I_pure_level_`x' + terme_A_pure_level_`x'
	gen ref_terme_AetI_`x' = terme_AetI_pure_`x'[1]
	replace terme_AetI_pure_`x' = 100*terme_AetI_pure_`x'/ref_terme_AetI_`x'
	
	gen terme_AetI_pure_`x'_np= terme_I_pure_level_`x'_np + terme_A_pure_level_`x'_np
	gen ref_terme_AetI_`x'_np = terme_AetI_pure_`x'_np[1]
	replace terme_AetI_pure_`x'_np = 100*terme_AetI_pure_`x'_np/ref_terme_AetI_`x'_np
	

}


drop ref* *level* ///
		terme_A_air_74  terme_I_air_74 terme_A_ves_74 terme_I_ves_74 

label var terme_AetI_pure_air "pureTC_AetI_air"
label var terme_AetI_pure_ves "pureTC_AetI_ves"

label var terme_AetI_pure_air_np "pureTC_AetI_air_np"
label var terme_AetI_pure_ves_np "pureTC_AetI_ves_np"

sort year

save "$dir_temp/temp.dta", replace



br

use "$dir_results/Effets de composition/compil_results_`sitc'", clear

sort year
merge 1:1 year using "$dir_temp/temp.dta"

keep if _merge==3
drop _merge


order year terme_obs* terme_A* terme_I*

save "$dir_results/Effets de composition/compil_results_`sitc'", replace



* Exporter sous excel

use "$dir_results/Effets de composition/compil_results_`sitc'", clear
keep year terme*


export excel using "$dir_results/Effets de composition/table_moreon_effetscomposition_`sitc'", replace firstrow(var)

*** Comparer les purs TC entre transport mode, selon qu'effets de composition élevés ou pas
*** Cf discussion de Hummels, les TC ont-ils plus baissé dans l'aérien que dans le vessel?

* Mai 2017, laisser de côté l'écart cif-fob observé

local type terme_A terme_I terme_AetI /* terme_obs */
local mode air ves
*capture rename terme_iceberg* termeiceberg*
 
** Pb 1989 Air TC overall, terme A et terme AetI

foreach z in terme_A terme_AetI {
	gen tt = 0.5*`z'_overall_air[_n-1]+ 0.5*`z'_overall_air[_n+1] if year==1989
	replace `z'_overall_air = tt  if year==1989
	*if dummy ==1  terme_A_overall_air[_n] tt[_n]
	drop tt
	
	}

	
foreach ponderation in "_np" "_mp" {
	if "`ponderation'" =="_mp" local ponderation 
	
	
	foreach x in `mode' {
		
		foreach z in `type' {
		
			replace `z'_pure_`x'`ponderation' = . if `z'_pure_`x'`ponderation' > 200
	*		label var `z'_pure_`x' "TC `z'_`x' hors effets de composition"
			
			*if "`z'"== "terme_AetI" & "`x'"== "air" label var `z'_overall_`x' "(a) Total transport costs, Air"
			*if "`z'"== "terme_AetI" & "`x'"== "ves" label var `z'_overall_`x' "(a) Total transport costs, Vessel"
			*if "`z'"== "terme_I" label var `z'_overall_`x' "(b) Multiplicative transport costs, `x'"
			*if "`z'"== "terme_A" label var `z'_overall_`x' "(c) Additive transport costs, `x'"
			
		
			if "`z'"== "terme_I" & "`x'"== "air" local title_graph  "(a) Multiplicative transport costs, air"
			if "`z'"== "terme_I" & "`x'"== "ves" local title_graph  "(d) Multiplicative transport costs, vessel"
			
			if "`z'"== "terme_A" & "`x'"== "air" local title_graph  "(b) Additive transport costs, air"
			if "`z'"== "terme_A" & "`x'"== "ves" local title_graph  "(e) Additive transport costs, vessel"
			
			if "`z'"== "terme_AetI" & "`x'"== "air" local title_graph  "(c) Total transport costs, air"
			if "`z'"== "terme_AetI" & "`x'"== "ves" local title_graph  "(f) Total transport costs, vessel"
			
	
			
			label var `z'_pure_`x'`ponderation' "idem, corrected for composition"
		
			replace `z'_overall_`x' = . if `z'_overall_`x' > 200
			
			
	
			if "`sitc'"!="all" twoway (line `z'_pure_`x'`ponderation' year, lcolor(navy))  ///
								(line `z'_overall_`x' year, lcolor(sienna) lpattern(shortdash)), ///
								name(`z'_`x', replace) nodraw legend(label(2 "Transport costs") ///
								label(1 "Transport costs, excluding composition effects") row(1) size(vsmall)) ///
								title("`title_graph'", size(small)) ///
								yscale(range(25 150)) ylabel(25(25)150, angle(horizontal) labsize(vsmall))
			if "`sitc'"=="all" twoway (line `z'_pure_`x'`ponderation' year) ///
								 (line `z'_overall_`x' year, lpattern(shortdash)) , ///
								name(`z'_`x', replace) nodraw legend(label(2 "Transport costs") ////
								label(1 "Transport costs, excluding composition effects") row(1) size(vsmall)) ///
								title("`title_graph'", size (small)) ///
								yscale(range(25 130)) ylabel(25(25)125, angle(horizontal) labsize(vsmall))
								
								
			
			
		}
		
		if "`sitc'"=="all" {
		
				if "`x'"== "air" local title_graph  "Air"
				if "`x'"== "ves" local title_graph  "Vessel"
				
				twoway (line terme_AetI_pure_`x'`ponderation' year, color(navy)) ///
					   (line terme_AetI_overall_`x' year, lpattern(shortdash) color(sienna)) ///
					   (lfit terme_AetI_pure_`x' year,  color(navy) ) ///
					   (lfit terme_AetI_overall_`x' year, lpattern(shortdash) color(sienna)) ///
								, name(terme_AetI_`x'_comp_hum, replace) nodraw legend(label(2 "Transport costs") ///
								label(1 "Transport costs, excluding composition effects") row(1) size(vsmall) order(1 2)) ///
								title("`title_graph'", size (medium)) ///
								yscale(range(25 130)) ylabel(25(25)125, angle(horizontal) labsize(vsmall)) ///
			
				
				preserve
				use "$dir_results/Effets de composition/effet_composition_hummels.dta", clear
					if "`x'"== "air" local title_graph  "Air, Hummels"
					if "`x'"== "ves" local title_graph  "Vessel, Hummels"
					if "`x'"=="air" local mode_short a
					if "`x'"=="ves" local mode_short v
				twoway (line `mode_short'fvhat_index year, color(navy)) ///
					   (line `mode_short'fv_wgt_index year, lpattern(shortdash) color(sienna)) ///
					   (lfit `mode_short'fvhat_index year,  color(navy)) ///
					   (lfit `mode_short'fv_wgt_index year, lpattern(shortdash) color(sienna)) ///
					  			, name(Hum_`x'_comp_hum, replace) nodraw legend(label(2 "Transport costs")  ///
								label(1 "Transport costs, excluding composition effects") row(1) size(vsmall) order(1 2)) ///
								title("`title_graph'", size (medium)) ///
								yscale(range(25 130)) ylabel(25(25)125, angle(horizontal) labsize(vsmall))
				restore
			
		}	
		
	
	}


if "`sitc'"=="all" grc1leg terme_I_air terme_I_ves terme_A_air terme_A_ves terme_AetI_air terme_AetI_ves, 				cols(2) title("Goods: All", size(small)) 
if "`sitc'"=="primary" grc1leg terme_I_air terme_I_ves terme_A_air terme_A_ves terme_AetI_air 				terme_AetI_ves, cols(2) title("Goods: Primary", size(small)) 
if "`sitc'"=="manuf" grc1leg terme_I_air terme_I_ves terme_A_air terme_A_ves terme_AetI_air terme_AetI_ves,			 	cols(2) title("Goods: Manufacturing", size(small)) 
graph save "$dir_results/Effets de composition/graph_composition_`sitc'`ponderation'", replace
graph export "$dir_results/Effets de composition/graph_composition_`sitc'`ponderation'.jpg", replace
blif

	if "`sitc'"=="all" {
		grc1leg Hum_air_comp_hum Hum_ves_comp_hum terme_AetI_air_comp_hum terme_AetI_ves_comp_hum , ///
		cols(2) title("Comparing the evolution of total transport costs with Hummels", size(small))
		
		graph save "$dir_results/Effets de composition/graph_comp_trend_hum_nous_`ponderation'", replace
		graph export "$dir_results/Effets de composition/graph_comp_trend_hum_nous_`ponderation'.jpg", replace
	}

}

erase temp.dta 

end

*****************************************************



set more off
local mode ves air
*local sitc 
foreach sitc in all /*primary manuf */ {
	foreach x in `mode' {
		*foreach z in `year' {
			foreach z of num 1974(1)2019 {	
			compare_trends_inTC `z' `x' `sitc'
		}
	}
	compilation_effets_compositions `sitc'	
}


/*

foreach sitc of num 0 1 2 3 4 5 6 7 8 9 {
	foreach x in `mode' {
		*foreach z in `year' {
			foreach z of num 1974(1)2013 {
			compare_trends_inTC `z' `x' `sitc'
		}
	}
	compilation_effets_compositions `sitc'	
}


