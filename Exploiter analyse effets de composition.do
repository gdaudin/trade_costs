***************************************************************************

* ---------- Programme pour reconstruire les coûts de commerce
* ---------- estimés "overall" et "pure", en base 100 en 1974 tous les deux

* Mai 2017: Construire la somme des deux termes IetA, overall et purs

****************************************************************************



version 14.1


if "`c(username)'" =="guillaumedaudin" {
	global dir ~/dropbox/trade_cost
}


if "`c(hostname)'" =="LAB0271A" {
	global dir C:\Users\lpatureau\Dropbox\trade_cost
}


if "`c(hostname)'" =="lise-HP" {
	global dir C:\Users\lise\Dropbox\trade_cost
}

if "`c(hostname)'" =="LABP112" {
    global dir C:\Users\lpatureau\Dropbox\trade_cost
}

cd $dir/results/

** On part sur estimation en 3 digits ***

capture program drop compare_trends_inTC
program compare_trends_inTC
	args year mode sitc


use "estimTC.dta", clear

keep if year==`year'
keep if mode=="`mode'"


foreach secteur in 0(1)9 {
	if "`sitc'"=="`secteur'" keep if substr(sector,1,1)=="`sitc'"
}

if "`sitc'"=="primary" keep if substr(sector,1,1)=="0" | substr(sector,1,1)=="1" /// 
	| substr(sector,1,1)=="2" | substr(sector,1,1)=="3" | substr(sector,1,1)=="4" /// 
	| substr(sector,1,3)=="667" | substr(sector,1,2)=="68"
	
	
	
	
if "`sitc'"=="manuf" drop if substr(sector,1,1)=="0" | substr(sector,1,1)=="1" /// 
	| substr(sector,1,1)=="2" | substr(sector,1,1)=="3" | substr(sector,1,1)=="4" /// 
	| substr(sector,1,3)=="667" | substr(sector,1,2)=="68" | substr(sector,1,1)=="9"
	

gen prix_trsp = prix_caf/prix_fob -1
replace terme_I = terme_I-1

gen terme_AetI = terme_A+terme_I
*gen termeiceberg = terme_iceberg -1


local type prix_trsp terme_I terme_A terme_AetI /*termeiceberg */
keep `type' year mode val

foreach x in `type' {

	quietly sum `x'  [fweight= val], det
	generate `x'_mp = r(mean)
	generate `x'_med = r(p50)
		
}



keep year mode prix_trsp_mp terme_I_mp terme_A_mp terme_AetI_mp /* termeiceberg_mp prix_trsp_med termeAetI_med termeiceberg_med */
rename prix_trsp_mp terme_obs_mp
keep if _n ==1

save "temp_`year'_`mode'_`sitc'", replace 


end



********************************

** Compiler les résultats sur toutes les années



capture program drop compilation_effets_compositions
program compilation_effets_compositions
args sitc
* expl : compilation_effets_compositions 6


set more off
local mode ves air



foreach x in `mode' {

	use temp_1974_`x'_`sitc', clear
	
	
	save compil_results_`x'_`sitc', replace
	erase temp_1974_`x'_`sitc'.dta
	
}

* Les années ultérieures


foreach x in `mode' {

	foreach z of num 1975(1)2013 {
	
		use compil_results_`x'_`sitc', clear
		append using temp_`z'_`x'_`sitc'
		
		save compil_results_`x'_`sitc', replace
		erase temp_`z'_`x'_`sitc'.dta
	
	}

}

* Fusionner les deux bases (air, vessel)
* Cette base contient le cout de transport (observé, estimé nlI, estimé I&A) moyen et médian par année et par mode de transport
* Le prix moyen et médian: calcul pondéré par la valeur du flux

use compil_results_air_`sitc', clear

append using compil_results_ves_`sitc'

save compil_results_`sitc', replace

erase compil_results_air_`sitc'.dta
erase compil_results_ves_`sitc'.dta

use compil_results_`sitc', clear

local type terme_obs terme_A terme_I terme_AetI


foreach z in `type' {
	
	rename `z'_mp `z'
	

}



*reshape wide prix_trsp termeAetI termeiceberg, i(year) j(mode) string
reshape wide terme_obs terme_A terme_I terme_AetI, i(year) j(mode) string

local type terme_obs terme_A terme_I terme_AetI
local mode air ves

foreach z in `type' {
	foreach x in `mode' {
	rename `z'`x' `z'_overall_`x'
	
}
}


save compil_results_`sitc', replace

*** Etape : Construire les variables de TC "overall" pour avoir 100 en 1974

use compil_results_`sitc', clear
sort year

local type terme_obs terme_A terme_I terme_AetI
local mode air ves


foreach x in `type' {
	foreach z in `mode'{

	gen ref_`x'_`z' = `x'_overall_`z'[1]
	replace `x'_overall_`z' = 100*`x'_overall_`z'/ref_`x'_`z'

}
}

drop ref*

save compil_results_`sitc', replace


*** Etape suivante : Y ajouter l'estimation des coûts de transport composition effects excluded

use "$dir/resultats_finaux/database_pureTC_`sitc'", clear

count

keep year terme_A_air_mp terme_A_ves_mp terme_A_air_np terme_A_ves_np ///
		  terme_A_air_74 terme_A_ves_74 terme_A_air_74_np terme_A_ves_74_np ///
		  terme_I_air_mp terme_I_ves_mp terme_I_air_np terme_I_ves_np ///
		  terme_I_air_74 terme_I_ves_74  terme_I_air_74_np terme_I_ves_74_np ///
		  terme_obs_air_mp terme_obs_ves_mp terme_obs_air_np terme_obs_ves_np

local type terme_A terme_I terme_obs
local mode air ves

foreach z in `type' {
	foreach x in `mode' {
	
			rename `z'_`x'_mp `z'_pure_`x'
			rename `z'_`x'_np `z'_pure_`x'_np
			
	}
}



* reconstruire le terme A+I "pur" à partir des termes I et A purs obtenus

/*
* Prendre la pondération en 1974

* cf table_extract_effetscomposition v27 juillet.xls dans le dossier résultats finaux
* poids relatif additif dans transport total en 1974 = 0.423 en air, 0.482 en vessel


gen terme_AetI_pure_air = 0.423*terme_A_pure_air + (1-0.423)*terme_I_pure_air
gen terme_AetI_pure_ves = 0.482*terme_A_pure_ves + (1-0.482)*terme_I_pure_ves


** Faire ça ou comme on fait ensuite ne change rien
** Pour mémoire, les graphiques correspondants sont stockés dans le dossier Dropbox/trade_costs/resultats_finaux
** Sous les noms "graph_composition_all_ponderation74_pure.pdf", "graph_composition_primary_ponderation74_pure.pdf", "graph_composition_primary_ponderation74_pure.pdf"

	
*/

local type A I
local mode air ves

foreach x in `mode' {
	
		
	
	gen terme_I_pure_level_`x' = (terme_I_pure_`x'*(terme_I_`x'_74-1))/100 	
	gen terme_I_pure_level_`x'_np = (terme_I_pure_`x'*(terme_I_`x'_74_np-1))/100 
	
		
	gen terme_A_pure_level_`x' = (terme_A_pure_`x'*(terme_A_`x'_74))/100 	
	gen terme_A_pure_level_`x'_np = (terme_A_pure_`x'*(terme_A_`x'_74_np))/100 

	
	
	gen terme_AetI_pure_`x'= terme_I_pure_level_`x' + terme_A_pure_level_`x'
	gen ref_terme_AetI_`x' = terme_AetI_pure_`x'[1]
	replace terme_AetI_pure_`x' = 100*terme_AetI_pure_`x'/ref_terme_AetI_`x'
	
	gen terme_AetI_pure_`x'_np= terme_I_pure_level_`x'_np + terme_A_pure_level_`x'_np
	gen ref_terme_AetI_`x'_np = terme_AetI_pure_`x'_np[1]
	replace terme_AetI_pure_`x'_np = 100*terme_AetI_pure_`x'_np/ref_terme_AetI_`x'_np
	

}


drop ref* *level* ///
		terme_A_air_74  terme_I_air_74 terme_A_ves_74 terme_I_ves_74 

label var terme_AetI_pure_air "pureTC_AetI_air"
label var terme_AetI_pure_ves "pureTC_AetI_ves"

label var terme_AetI_pure_air_np "pureTC_AetI_air_np"
label var terme_AetI_pure_ves_np "pureTC_AetI_ves_np"

sort year

save temp, replace

use "$dir/results/compil_results_`sitc'", clear

sort year
merge 1:1 year using temp

keep if _merge==3
drop _merge

order year terme_obs* terme_A* terme_I*

save compil_results_`sitc', replace

* Exporter sous excel

use compil_results_`sitc', clear
keep year terme*


export excel using table_moreon_effetscomposition_`sitc', replace firstrow(var)

*** Comparer les purs TC entre transport mode, selon qu'effets de composition élevés ou pas
*** Cf discussion de Hummels, les TC ont-ils plus baissé dans l'aérien que dans le vessel?

* Mai 2017, laisser de côté l'écart cif-fob observé

local type terme_A terme_I terme_AetI /* terme_obs */
local mode air ves
*capture rename terme_iceberg* termeiceberg*
 
** Pb 1989 Air TC overall, terme A et terme AetI

foreach z in terme_A terme_AetI {
	gen tt = 0.5*`z'_overall_air[_n-1]+ 0.5*`z'_overall_air[_n+1] if year==1989
	replace `z'_overall_air = tt  if year==1989
	*if dummy ==1  terme_A_overall_air[_n] tt[_n]
	drop tt
	
	}

	
foreach ponderation in "_np" "_mp" {
	if "`ponderation'" =="_mp" local ponderation 
	
	foreach x in `mode' {
		
		foreach z in `type' {
		
			replace `z'_pure_`x'`ponderation' = . if `z'_pure_`x'`ponderation' > 200
	*		label var `z'_pure_`x' "TC `z'_`x' hors effets de composition"
			
			*if "`z'"== "terme_AetI" & "`x'"== "air" label var `z'_overall_`x' "(a) Total transport costs, Air"
			*if "`z'"== "terme_AetI" & "`x'"== "ves" label var `z'_overall_`x' "(a) Total transport costs, Vessel"
			*if "`z'"== "terme_I" label var `z'_overall_`x' "(b) Multiplicative transport costs, `x'"
			*if "`z'"== "terme_A" label var `z'_overall_`x' "(c) Additive transport costs, `x'"
			
		
			if "`z'"== "terme_I" & "`x'"== "air" local title_graph  "(a) Multiplicative transport costs, Air"
			if "`z'"== "terme_I" & "`x'"== "ves" local title_graph  "(d) Multiplicative transport costs, Vessel"
			
			if "`z'"== "terme_A" & "`x'"== "air" local title_graph  "(b) Additive transport costs, Air"
			if "`z'"== "terme_A" & "`x'"== "ves" local title_graph  "(e) Additive transport costs, Vessel"
			
			if "`z'"== "terme_AetI" & "`x'"== "air" local title_graph  "(c) Total transport costs, Air"
			if "`z'"== "terme_AetI" & "`x'"== "ves" local title_graph  "(f) Total transport costs, Vessel"
			
	
			
			label var `z'_pure_`x'`ponderation' "idem, corrected for composition"
		
			replace `z'_overall_`x' = . if `z'_overall_`x' > 200
	
			if "`sitc'"!="all" twoway (line `z'_pure_`x'`ponderation' year, lcolor(navy))  ///
								(line `z'_overall_`x' year, lcolor(sienna) lpattern(shortdash)), ///
								name(`z'_`x', replace) nodraw legend(label(2 "Transport cost") ///
								label(1 "TC, excluding composition effects") row(1) size(vsmall)) ///
								title("`title_graph'", size(small)) ///
								yscale(range(25 150)) ylabel(25(25)150, angle(horizontal) labsize(vsmall))
			if "`sitc'"=="all" twoway (line `z'_pure_`x'`ponderation' year) ///
								 (line `z'_overall_`x' year, lpattern(shortdash)) , ///
								name(`z'_`x', replace) nodraw legend(label(2 "Transport cost") ////
								label(1 "TC, excluding composition effects") row(1) size(vsmall)) ///
								title("`title_graph'", size (small)) ///
								yscale(range(25 130)) ylabel(25(25)125, angle(horizontal) labsize(vsmall))
								
								
			
			
		}
		if "`sitc'"=="all" {
		
				if "`x'"== "air" local title_graph  "Air"
				if "`x'"== "ves" local title_graph  "Vessel"
				twoway (line terme_AetI_pure_`x'`ponderation' year, color(navy)) ///
					   (line terme_AetI_overall_`x' year, lpattern(shortdash) color(sienna)) ///
					   (lfit terme_AetI_pure_`x' year,  color(navy) ) ///
					   (lfit terme_AetI_overall_`x' year, lpattern(shortdash) color(sienna)) ///
								, name(terme_AetI_`x'_comp_hum, replace) nodraw legend(label(2 "Transport cost") ///
								label(1 "TC, excluding composition effects") row(1) size(vsmall) order(1 2)) ///
								title("`title_graph'", size (medium)) ///
								yscale(range(25 130)) ylabel(25(25)125, angle(horizontal) labsize(vsmall)) ///
			

				preserve
				use "/Users/guillaumedaudin/Documents/Recherche/Trade Costs/results/effet_composition_hummels.dta", clear
					if "`x'"== "air" local title_graph  "Air, Hummels"
					if "`x'"== "ves" local title_graph  "Vessel, Hummels"
					if "`x'"=="air" local mode_short a
					if "`x'"=="ves" local mode_short v
				twoway (line `mode_short'fvhat_index year, color(navy)) ///
					   (line `mode_short'fv_wgt_index year, lpattern(shortdash) color(sienna)) ///
					   (lfit `mode_short'fvhat_index year,  color(navy)) ///
					   (lfit `mode_short'fv_wgt_index year, lpattern(shortdash) color(sienna)) ///
					  			, name(Hum_`x'_comp_hum, replace) nodraw legend(label(2 "Transport cost")  ///
								label(1 "TC, excluding composition effects") row(1) size(vsmall) order(1 2)) ///
								title("`title_graph'", size (medium)) ///
								yscale(range(25 130)) ylabel(25(25)125, angle(horizontal) labsize(vsmall))
				restore
			
		}	
		
	
	}


if "`sitc'"=="all" grc1leg terme_I_air terme_I_ves terme_A_air terme_A_ves terme_AetI_air terme_AetI_ves, cols(2) title("Goods: All", size(small)) 
if "`sitc'"=="primary" grc1leg terme_I_air terme_I_ves terme_A_air terme_A_ves terme_AetI_air terme_AetI_ves, cols(2) title("Goods: Primary", size(small)) 
if "`sitc'"=="manuf" grc1leg terme_I_air terme_I_ves terme_A_air terme_A_ves terme_AetI_air terme_AetI_ves, cols(2) title("Goods: Manufacturing", size(small)) 
graph save "$dir/resultats_finaux/graph_composition_`sitc'`ponderation'", replace
graph export "$dir/resultats_finaux/graph_composition_`sitc'`ponderation'.pdf", replace

	if "`sitc'"=="all" {
		grc1leg Hum_air_comp_hum Hum_ves_comp_hum terme_AetI_air_comp_hum terme_AetI_ves_comp_hum , ///
		cols(2) title("Comparing the evolution of total transport costs with Hummels", size(small))
		
		graph save "$dir/resultats_finaux/graph_comp_trend_hum_nous_`ponderation'", replace
		graph export "$dir/resultats_finaux/graph_comp_trend_hum_nous_`ponderation'.pdf", replace
	}

}

erase temp.dta 

end

*****************************************************



set more off
local mode ves air
local sitc all
foreach sitc in /*all*/ primary manuf  {
	foreach x in `mode' {
		*foreach z in `year' {
			foreach z of num 1974(1)2013 {	
			compare_trends_inTC `z' `x' `sitc'
		}
	}
	compilation_effets_compositions `sitc'	
}


/*

foreach sitc of num 0 1 2 3 4 5 6 7 8 9 {
	foreach x in `mode' {
		*foreach z in `year' {
			foreach z of num 1974(1)2013 {
			compare_trends_inTC `z' `x' `sitc'
		}
	}
	compilation_effets_compositions `sitc'	
}


