***************************************************************************

* ---------- Programme pour reconstruire les coûts de commerce
* ---------- estimés "overall" et "pure", en base 100 en 1974 tous les deux

****************************************************************************



version 14.1


if "`c(username)'" =="guillaumedaudin" {
	global dir ~/dropbox/trade_cost
}


if "`c(hostname)'" =="LAB0271A" {
	global dir C:\Users\lpatureau\Dropbox\trade_cost
}


if "`c(hostname)'" =="lise-HP" {
	global dir C:\Users\lise\Dropbox\trade_cost
}

cd $dir/results/

** On part sur estimation en 3 digits ***

capture program drop compare_trends_inTC
program compare_trends_inTC
	args year mode sitc


use "estimTC.dta", clear

keep if year==`year'
keep if mode=="`mode'"
if "`sitc'" != "all" keep if substr(product,1,1)=="`sitc'"

gen prix_trsp = prix_caf/prix_fob -1
gen termeAetI = terme_A+terme_I-1
gen termeiceberg = terme_iceberg -1


local type prix_trsp termeAetI termeiceberg 
keep `type' year mode val

foreach x in `type' {

	quietly sum `x'  [fweight= val], det
	generate `x'_mp = r(mean)
	generate `x'_med = r(p50)
		
}



keep year mode prix_trsp_mp termeAetI_mp termeiceberg_mp /*prix_trsp_med termeAetI_med termeiceberg_med */
keep if _n ==1

save "temp_`year'_`mode'_`sitc'", replace 


end

********************************

** Compiler les résultats sur toutes les années



capture program drop compilation_effets_compositions
program compilation_effets_compositions
args sitc
* expl : compilation_effets_compositions 6


set more off
local mode ves air



foreach x in `mode' {

	use temp_1974_`x'_`sitc', clear
	
	
	save compil_results_`x'_`sitc', replace
	erase temp_1974_`x'_`sitc'.dta
	
}

* Les années ultérieures


foreach x in `mode' {

	foreach z of num 1975(1)2013 {
	
		use compil_results_`x'_`sitc', clear
		append using temp_`z'_`x'_`sitc'
		
		save compil_results_`x'_`sitc', replace
		erase temp_`z'_`x'_`sitc'.dta
	
	}

}

* Fusionner les deux bases (air, vessel)
* Cette base contient le cout de transport (observé, estimé nlI, estimé I&A) moyen et médian par année et par mode de transport
* Le prix moyen et médian: calcul pondéré par la valeur du flux

use compil_results_air_`sitc', clear

append using compil_results_ves_`sitc'

save compil_results_`sitc', replace

erase compil_results_air_`sitc'.dta
erase compil_results_ves_`sitc'.dta

use compil_results_`sitc', clear

local type prix_trsp termeAetI termeiceberg 


foreach z in `type' {
	
	rename `z'_mp `z'
	

}



reshape wide prix_trsp termeAetI termeiceberg, i(year) j(mode) string


rename prix_trspair prix_trsp_air
rename prix_trspves prix_trsp_ves

local type termeAetI termeiceberg
local mode air ves

foreach z in `type' {
	foreach x in `mode' {
	rename `z'`x' `z'_overall_`x'
	
}
}


save compil_results_`sitc', replace

*** Etape : Construire les variables de TC "overall" pour avoir 100 en 1974

use compil_results_`sitc', clear
sort year

local type termeiceberg termeAetI
local mode air ves


foreach x in `type' {
	foreach z in `mode'{

	gen ref_`x'_`z' = `x'_overall_`z'[1]
	replace `x'_overall_`z' = 100*`x'_overall_`z'/ref_`x'_`z'

}
}

drop ref*

save compil_results_`sitc', replace


*** Etape suivante : Y ajouter l'estimation des coûts de transport composition effects excluded


use "$dir/resultats_finaux/database_pureTC_`sitc'", clear

count
keep year terme_A_air_mp terme_A_ves_mp terme_I_air_mp terme_I_ves_mp terme_iceberg_air_mp terme_iceberg_ves_mp

local type terme_A terme_I terme_iceberg 
local mode air ves

foreach z in `type' {
	foreach x in `mode' {
	
			rename `z'_`x'_mp `z'_pure_`x'
	}
}

* cf table_extract_effetscomposition v27 juillet.xls dans le dossier résultats finaux
* poids relatif additif dans transport total en 1974 = 0.423 en air, 0.482 en vessel


gen termeAetI_pure_air = 0.423*terme_A_pure_air + (1-0.423)*terme_I_pure_air
gen termeAetI_pure_ves = 0.482*terme_A_pure_ves + (1-0.482)*terme_I_pure_ves

sort year

save temp, replace

use "$dir/results/compil_results_`sitc'", clear

sort year
merge 1:1 year using temp

keep if _merge==3
drop _merge

order year termeAetI* termeiceberg*

save compil_results_`sitc', replace


* Exporter sous excel

use compil_results_`sitc', clear
keep year termeAetI* terme*iceberg*


export excel using table_moreon_effetscomposition_`sitc', replace firstrow(var)

*** Comparer les purs TC entre transport mode, selon qu'effets de composition élevés ou pas
*** Cf discussion de Hummels, les TC ont-ils plus baissé dans l'aérien que dans le vessel?


local type termeAetI termeiceberg
local mode air ves
capture rename terme_iceberg* termeiceberg*
 

foreach z in `type' {
	foreach x in `mode' {
		replace `z'_pure_`x' = . if `z'_pure_`x' > 200
		label var `z'_pure_`x' "TC `z'_`x' hors effets de composition"
		replace `z'_overall_`x' = . if `z'_overall_`x' > 200
		label var `z'_overall_`x' "TC `z'_`x'"

		twoway(line `z'_pure_`x' year) (line `z'_overall_`x' year), name(`z'_`x', replace) nodraw legend(row(2) size(small)) yscale(range(0 200)) ylabel(0(50)200)
	}
}

graph combine termeAetI_air termeAetI_ves termeiceberg_air  termeiceberg_ves, title("goods : `sitc'") 

erase temp.dta 

end

*****************************************************


set more off
local mode ves air
local sitc 0

foreach x in `mode' {

	*foreach z in `year' {
		foreach z of num 1974(1)2013 {
		
		
		compare_trends_inTC `z' `x' `sitc'
		
	
	}
}


compilation_effets_compositions `sitc'
