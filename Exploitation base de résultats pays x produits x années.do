*************************************************
* Programme 6 : Programme pour estimer les déterminants des trade costs - 2d stage

*************************************************


clear all
*set mem 800m
set matsize 8000
set more off
set maxvar 32767


if "`c(hostname)'" =="MacBook-Pro-Lysandre.local" {
	global dir ~/dropbox/trade_cost
}


if "`c(hostname)'" =="LAB0271A" {
	global dir C:\Users\lpatureau\Dropbox/trade_cost
	
}


	 
	 
** charger la base de données

cd $dir/results

global dist "distance"

global Prcone "$^{a}$"
global Prcfive "$^{b}$"
global Prcten "$^{c}$"
global Footnote "Standard errors in parentheses with $Prcone, $Prcfive and $Prcten respectively denoting significance at the 1\%, 5\% and 10\% levels."

/*
capture program drop reg_FE_h
program reg_FE_h
args preci mode
*/

*pour test du pgm 

** 3 digits, air ***


local mode air
local preci 3

log close _all
log using results_2dstage_`preci'_`mode'.log, replace

* exemple : reg_FE 2006 sitc3 3 air
* rod_var "hs hs6 SIC sitc2 sitc3 naics"


use estimTC_augmented, clear

destring product, replace



* on ne retient que la dimension digits / mode 
keep if mode == "`mode'"
keep if nbdigits ==`preci'

** La variable "cost-to-export" n'est renseignée qu'à partir de 2004, dans la benchmark regression on ne regarde que sur 2004-2013

egen tt = group(year)
egen tt1 = max(tt)

local nb_year = tt1 -1

egen year_start = min(year)

* On exprime la distance en dizaine de milliers de km
replace dist = dist/10000


** Génerer les explicatives

* oil price / prix fob = price of a barrel per USD exported
gen oil_perusd_exported = oilprice/prix_fob

* (oil price / prix fob)*dist = price of a barrel per km exported
gen oil_perkm_exported = oil_perusd_exported*dist

* export cost/prox fob = overall cost of export formality, per USD exported
gen formality_perusd_exported = Cost_to_export/prix_fob


forvalues x = 1(1)`nb_year' {
local z= year_start +`x'
gen yearFE_`z' = 0 
replace yearFE_`z' = 1 if year== `z'

gen oil_perkm_exported_yearFE_`z' = oil_perkm_exported*yearFE_`z'
gen dist_yearFE_`z' = dist*yearFE_`z'
gen oil_yearFE_`z' = oil_perusd_exported*yearFE_`z'

drop yearFE*
}


*** Retraitement des termes iceberg et terme I pour avoir le pourcentage

replace terme_iceberg = terme_iceberg -1
replace terme_I = terme_I -1



foreach dependent in terme_iceberg terme_A terme_I {



* Régression 1 - distance seulement
* en pondérant chaque obs par les flux en valeur 
reg `dependent' dist i.year i.product [iweight=val]

blouf

outreg2 using Tab_results_`dependent', nolabel title ("Dependent variable: `dependent'") ctitle(A) bdec(3) rdec(2) keep(dist) se symbol($^a$, $^b$,$^c$) nocons noni  nonotes addtext(Country FE, Yes) addnote($Footnote) replace 

** Régression 2 - distance + interagir distance et année

order dist dist_yearFE*

local start = year_start + 1
* en pondérant chaque obs par les flux en valeur 
reg `dependent' dist dist_yearFE_`start'-dist_yearFE_2013  i.year [iweight=val]
outreg2 using Tab_results_`dependent', nolabel ctitle(B) bdec(3) rdec(2) keep(dist) se symbol($^a$, $^b$,$^c$) nocons noni  nonotes addtext(Country FE, Yes, Dist $\times$ Country FE, Yes) append 


* régression complète
reg `dependent' dist dist_yearFE_`start'-dist_yearFE_2013 formality_perusd_exported oil_perusd_exported oil_perkm_exported oil_perkm_exported_yearFE_`start'-oil_perkm_exported_yearFE_2013 oil_yearFE_`start'-oil_yearFE_2013 i.year [iweight=val] 
outreg2 using Tab_results_`dependent', nolabel ctitle(C) bdec(3) rdec(2) keep(dist oil_perusd_exported oil_perkm_exported formality_perusd_exported ) se symbol($^a$, $^b$,$^c$) nocons noni  nonotes addtext(Country FE, Yes, Dist $\times$ Country FE, Yes, Oil $\times$ Country FE, Yes, Oil$\times$ Dist $\times$ Country FE, Yes) append 


}



log close



